---
import MainLayout from '../../layouts/MainLayout.astro';
import { getCollection } from 'astro:content';
import { collectMeta, sortByDateDesc } from '../../lib/blog';

const entries = await getCollection('blog', ({ data }) => !data.draft);
const posts = sortByDateDesc(entries).map(collectMeta);

const pageTitle = '–ë–ª–æ–≥ —à–∫–æ–ª—ã —è–ø–æ–Ω—Å–∫–æ–≥–æ —è–∑—ã–∫–∞';
const description = '–°—Ç–∞—Ç—å–∏ –æ —è–ø–æ–Ω—Å–∫–æ–º —è–∑—ã–∫–µ, –ø–æ–¥–≥–æ—Ç–æ–≤–∫–µ –∫ JLPT, –º–µ—Ç–æ–¥–∏–∫–µ –∏ –∫—É–ª—å—Ç—É—Ä–Ω—ã—Ö –∑–∞–º–µ—Ç–∫–∞—Ö.';

// –ü–æ–ª—É—á–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏–∑ –ø–æ—Å—Ç–æ–≤
const allCategories = ['–í—Å–µ']; // –≤—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º "–í—Å–µ"
posts.forEach(post => {
  if (post.category && !allCategories.includes(post.category)) {
    allCategories.push(post.category);
  }
});
---
<MainLayout pageTitle={pageTitle} description={description} canonical="/blog/">
  <Fragment slot="head">
    <link rel="stylesheet" href="/src/styles/components/blog-card.css">
  </Fragment>

  <!-- Hero Section -->
  <section class="blog-hero">
    <div class="blog-hero__bg">
      <div class="blog-hero__blob blog-hero__blob--1"></div>
      <div class="blog-hero__blob blog-hero__blob--2"></div>
      <div class="blog-hero__particles"></div>
    </div>

    <div class="container">
      <a href="/" class="blog-hero__back">‚Üê –ì–ª–∞–≤–Ω–∞—è</a>

      <div class="blog-hero__content">
        <h1 class="blog-hero__title">
          <span class="blog-hero__title-line">–ë–ª–æ–≥ —à–∫–æ–ª—ã</span>
          <span class="blog-hero__title-line">—è–ø–æ–Ω—Å–∫–æ–≥–æ —è–∑—ã–∫–∞</span>
        </h1>
        <p class="blog-hero__desc">{description}</p>

        <div class="blog-hero__stats">
          <div class="blog-hero__stat">
            <span class="blog-hero__stat-number">{posts.length}</span>
            <span class="blog-hero__stat-label">–°—Ç–∞—Ç–µ–π</span>
          </div>
          <div class="blog-hero__stat">
            <span class="blog-hero__stat-number">{allCategories.length - 1}</span>
            <span class="blog-hero__stat-label">–ö–∞—Ç–µ–≥–æ—Ä–∏–π</span>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Main Content -->
  <main class="blog-main container">
    <!-- Search & Filters -->
    <div class="blog-toolbar">
      <div class="blog-search">
        <input
          type="search"
          class="blog-search__input"
          placeholder="–ü–æ–∏—Å–∫ —Å—Ç–∞—Ç–µ–π..."
          id="blog-search"
          autocomplete="off"
        />
        <span class="blog-search__icon">üîç</span>
        <span class="blog-search__count" id="search-count" style="display: none;"></span>
      </div>

      <div class="blog-filters" id="blog-filters">
        {allCategories.map((category, index) => (
          <button
            class={`blog-filter ${index === 0 ? 'blog-filter--active' : ''}`}
            data-category={category}
          >
            {category}
          </button>
        ))}
      </div>
    </div>

    <!-- Blog Grid -->
    {posts.length > 0 ? (
      <div class="blog-grid" id="blog-grid">
        {posts.map((post) => (
          <article class="blog-card" data-category={post.category || '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏'}>
            <a class="blog-card__link" href={`/blog/${post.slug}/`}>
              <div
                class="blog-card__media"
                style={post.cover ? `background-image: url(${post.cover})` : ''}
                data-state="loading"
              >
                {post.cover && (
                  <img
                    class="blog-card__image"
                    src={post.cover}
                    alt={post.title}
                    loading="lazy"
                    onload="this.parentElement.removeAttribute('data-state')"
                  />
                )}
                {post.category && (
                  <span class="blog-card__category">{post.category}</span>
                )}
                {post.isNew && (
                  <span class="blog-card__badge">NEW</span>
                )}
              </div>

              <div class="blog-card__content">
                <h2 class="blog-card__title">{post.title}</h2>

                {post.description && (
                  <p class="blog-card__desc">{post.description}</p>
                )}

                <div class="blog-card__footer">
                  <span class="blog-card__read-more">–ß–∏—Ç–∞—Ç—å</span>
                  <span class="blog-card__time">{post.readingTime} –º–∏–Ω</span>
                </div>
              </div>
            </a>
          </article>
        ))}
      </div>
    ) : (
      <div class="blog-empty">
        <p>–°—Ç–∞—Ç–µ–π –ø–æ–∫–∞ –Ω–µ—Ç ‚Äî –∑–∞–≥–ª—è–Ω–∏—Ç–µ –ø–æ–∑–∂–µ.</p>
      </div>
    )}

    <!-- No Results Message -->
    <div class="blog-no-results" id="no-results" style="display: none;">
      <p>üòî –ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å.</p>
    </div>
  </main>

  <script>
    // Search and Filter functionality
    const searchInput = document.getElementById('blog-search') as HTMLInputElement;
    const searchCount = document.getElementById('search-count') as HTMLElement;
    const blogGrid = document.getElementById('blog-grid') as HTMLElement;
    const noResults = document.getElementById('no-results') as HTMLElement;
    const filters = document.querySelectorAll('.blog-filter');
    let currentCategory = '–í—Å–µ';

    function filterPosts() {
      const searchTerm = searchInput.value.toLowerCase().trim();
      const cards = blogGrid.querySelectorAll('.blog-card');
      let visibleCount = 0;

      cards.forEach((card) => {
        const title = card.querySelector('.blog-card__title')?.textContent?.toLowerCase() || '';
        const desc = card.querySelector('.blog-card__desc')?.textContent?.toLowerCase() || '';
        const category = card.getAttribute('data-category') || '';

        const matchesSearch = !searchTerm || title.includes(searchTerm) || desc.includes(searchTerm);
        const matchesCategory = currentCategory === '–í—Å–µ' || category === currentCategory;

        if (matchesSearch && matchesCategory) {
          (card as HTMLElement).style.display = '';
          visibleCount++;
        } else {
          (card as HTMLElement).style.display = 'none';
        }
      });

      // Update UI
      if (searchTerm) {
        searchCount.textContent = `${visibleCount} –Ω–∞–π–¥–µ–Ω–æ`;
        searchCount.style.display = 'block';
      } else {
        searchCount.style.display = 'none';
      }

      // Show/hide no results
      if (visibleCount === 0) {
        blogGrid.style.display = 'none';
        noResults.style.display = 'block';
      } else {
        blogGrid.style.display = 'grid';
        noResults.style.display = 'none';
      }
    }

    // Search input handler
    searchInput?.addEventListener('input', filterPosts);

    // Filter buttons handler
    filters.forEach(filter => {
      filter.addEventListener('click', () => {
        // Update active state
        filters.forEach(f => f.classList.remove('blog-filter--active'));
        filter.classList.add('blog-filter--active');

        // Update current category
        currentCategory = filter.getAttribute('data-category') || '–í—Å–µ';

        // Filter posts
        filterPosts();
      });
    });

    // Remove loading state after a timeout
    setTimeout(() => {
      document.querySelectorAll('[data-state="loading"]').forEach(el => {
        el.removeAttribute('data-state');
      });
    }, 2000);
  </script>

  <style>
    /* Hero Section */
    .blog-hero {
      position: relative;
      min-height: 60vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 8rem 0 6rem;
      overflow: hidden;
      background: linear-gradient(165deg, var(--bg), var(--bg-alt));
    }

    .blog-hero__bg {
      position: absolute;
      inset: 0;
      overflow: hidden;
      z-index: 0;
    }

    .blog-hero__blob {
      position: absolute;
      border-radius: 50%;
      filter: blur(80px);
      opacity: 0.5;
      animation: blobFloat 8s ease-in-out infinite;
    }

    .blog-hero__blob--1 {
      width: 500px;
      height: 500px;
      background: radial-gradient(circle, rgba(var(--primary-rgb), 0.4), transparent 70%);
      top: -10%;
      right: -10%;
      animation-delay: 0s;
    }

    .blog-hero__blob--2 {
      width: 400px;
      height: 400px;
      background: radial-gradient(circle, rgba(var(--accent-rgb), 0.3), transparent 70%);
      bottom: -15%;
      left: -5%;
      animation-delay: 2s;
    }

    @keyframes blobFloat {
      0%, 100% {
        transform: translate(0, 0) scale(1);
      }
      33% {
        transform: translate(30px, -30px) scale(1.1);
      }
      66% {
        transform: translate(-20px, 20px) scale(0.9);
      }
    }

    .blog-hero__back {
      display: inline-block;
      margin-bottom: 2rem;
      color: var(--primary);
      text-decoration: none;
      font-size: 0.9rem;
      font-weight: 600;
      letter-spacing: 0.5px;
      text-transform: uppercase;
      transition: all 0.3s ease;
      position: relative;
      z-index: 2;
    }

    .blog-hero__back:hover {
      gap: 0.8rem;
      color: var(--accent);
    }

    .blog-hero__content {
      text-align: center;
      position: relative;
      z-index: 2;
      max-width: 800px;
      margin: 0 auto;
    }

    .blog-hero__title {
      font-family: var(--font-display);
      font-size: clamp(2.5rem, 8vw, 4.5rem);
      font-weight: 700;
      line-height: 1.1;
      margin-bottom: 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .blog-hero__title-line {
      background: linear-gradient(135deg, var(--primary), var(--accent), var(--primary));
      background-size: 200% auto;
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      animation: gradientFlow 4s ease infinite;
    }

    @keyframes gradientFlow {
      0%, 100% {
        background-position: 0% 50%;
      }
      50% {
        background-position: 100% 50%;
      }
    }

    .blog-hero__desc {
      font-size: 1.25rem;
      color: var(--ink-soft);
      margin-bottom: 3rem;
      line-height: 1.6;
    }

    .blog-hero__stats {
      display: flex;
      gap: 3rem;
      justify-content: center;
    }

    .blog-hero__stat {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.5rem;
    }

    .blog-hero__stat-number {
      font-size: 3rem;
      font-weight: 700;
      background: linear-gradient(135deg, var(--primary), var(--accent));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      font-family: var(--font-display);
    }

    .blog-hero__stat-label {
      font-size: 0.9rem;
      color: var(--ink-dim);
      text-transform: uppercase;
      letter-spacing: 1px;
      font-weight: 600;
    }

    /* Main Content */
    .blog-main {
      padding: 4rem 0;
      max-width: 1400px;
    }

    /* Toolbar */
    .blog-toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 2rem;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 4rem;
      padding: 2rem;
      background: linear-gradient(
        135deg,
        rgba(var(--surface-rgb), 0.6),
        rgba(var(--surface-alt-rgb), 0.5)
      );
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border-radius: var(--radius-lg);
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow:
        0 8px 32px -8px rgba(0, 0, 0, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.05);
    }

    /* Search */
    .blog-search {
      position: relative;
      flex: 1;
      min-width: 300px;
      max-width: 500px;
    }

    .blog-search__input {
      width: 100%;
      padding: 1rem 3.5rem 1rem 3.5rem;
      background: rgba(var(--bg-rgb), 0.8);
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: var(--radius);
      color: var(--ink);
      font-size: 1rem;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .blog-search__input:focus {
      outline: none;
      border-color: var(--primary);
      background: var(--bg);
      box-shadow: 0 0 0 4px rgba(var(--primary-rgb), 0.15);
      transform: translateY(-2px);
    }

    .blog-search__icon {
      position: absolute;
      left: 1.25rem;
      top: 50%;
      transform: translateY(-50%);
      font-size: 1.2rem;
      pointer-events: none;
    }

    .blog-search__count {
      position: absolute;
      right: 1.25rem;
      top: 50%;
      transform: translateY(-50%);
      font-size: 0.75rem;
      font-weight: 700;
      color: var(--primary);
      background: rgba(var(--primary-rgb), 0.15);
      padding: 0.35rem 0.8rem;
      border-radius: 12px;
    }

    /* Filters */
    .blog-filters {
      display: flex;
      flex-wrap: wrap;
      gap: 0.8rem;
    }

    .blog-filter {
      padding: 0.75rem 1.5rem;
      background: rgba(var(--bg-rgb), 0.6);
      border: 2px solid rgba(var(--primary-rgb), 0.3);
      border-radius: 24px;
      color: var(--ink-soft);
      font-size: 0.85rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      letter-spacing: 0.5px;
      text-transform: uppercase;
    }

    .blog-filter:hover {
      border-color: rgba(var(--primary-rgb), 0.6);
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(var(--primary-rgb), 0.25);
    }

    .blog-filter--active {
      background: linear-gradient(135deg, var(--primary), var(--accent));
      color: #fff;
      border-color: transparent;
      box-shadow: 0 8px 24px rgba(var(--primary-rgb), 0.4);
      transform: translateY(-2px);
    }

    /* Grid */
    .blog-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(360px, 1fr));
      gap: 2.5rem;
      margin-bottom: 4rem;
    }

    /* Empty State */
    .blog-empty,
    .blog-no-results {
      text-align: center;
      padding: 4rem 2rem;
      color: var(--ink-dim);
      font-size: 1.1rem;
    }

    .blog-no-results p {
      font-size: 1.2rem;
      margin: 0;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .blog-hero {
        padding: 6rem 0 4rem;
        min-height: 50vh;
      }

      .blog-hero__stats {
        gap: 2rem;
      }

      .blog-hero__stat-number {
        font-size: 2.5rem;
      }

      .blog-toolbar {
        flex-direction: column;
        align-items: stretch;
        padding: 1.5rem;
      }

      .blog-search {
        max-width: 100%;
      }

      .blog-grid {
        grid-template-columns: 1fr;
        gap: 2rem;
      }
    }
  </style>
</MainLayout>
