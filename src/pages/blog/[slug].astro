---
import MainLayout from '../../layouts/MainLayout.astro';
import { getCollection } from 'astro:content';
import { buildSlug, collectMeta } from '../../lib/blog';
import siteConfig from '../../../site.config.json' with { type: 'json' };

export async function getStaticPaths() {
  const entries = await getCollection('blog', ({ data }) => !data.draft);
  return entries.map((entry) => ({
    params: { slug: buildSlug(entry) },
    props: { entry }
  }));
}

const { entry } = Astro.props;

if (!entry) {
  throw Astro.redirect('/blog/');
}

const { Content, headings } = await entry.render();
const meta = collectMeta(entry);
const toc = headings.filter((heading) => heading.depth === 2 || heading.depth === 3);
const canonical = `/blog/${meta.slug}/`;
const coverSrc = entry.data.cover ? `/${entry.data.cover.replace(/^\/+/, '')}` : undefined;
const description = meta.description || 'Статья школы японского языка';

const breadcrumbJson = {
  '@context': 'https://schema.org',
  '@type': 'BreadcrumbList',
  itemListElement: [
    { '@type': 'ListItem', position: 1, name: 'Главная', item: `${Astro.site?.href || siteConfig.siteUrl}/` },
    { '@type': 'ListItem', position: 2, name: 'Блог', item: `${Astro.site?.href || siteConfig.siteUrl}/blog/` },
    { '@type': 'ListItem', position: 3, name: meta.title, item: `${Astro.site?.href || siteConfig.siteUrl}/blog/${meta.slug}/` }
  ]
};

const articleJson = {
  '@context': 'https://schema.org',
  '@type': 'Article',
  headline: meta.title,
  datePublished: meta.isoDate,
  dateModified: meta.modified || meta.isoDate,
  description,
  image: coverSrc ? `${Astro.site?.href || siteConfig.siteUrl}${coverSrc}` : `${Astro.site?.href || siteConfig.siteUrl}/og-image.png`,
  mainEntityOfPage: `${Astro.site?.href || siteConfig.siteUrl}/blog/${meta.slug}/`,
  author: { '@type': 'Organization', name: siteConfig.siteName }
};
---
<MainLayout
  pageTitle={meta.title}
  description={description}
  keywords={meta.keywords}
  canonical={canonical}
  preloadImages={coverSrc ? [coverSrc] : []}
>
  <Fragment slot="head">
    <script is:inline type="application/ld+json" set:html={JSON.stringify(articleJson)} />
    <script is:inline type="application/ld+json" set:html={JSON.stringify(breadcrumbJson)} />
    <style is:global>
      /* Styles moved to src/styles/components/blog-post.css */
    </style>
  </Fragment>
  <div class="blog-post__progress" aria-hidden="true"><span id="readingBar" class="blog-post__progress-bar"></span></div>
  <main class="container rich-text" style="padding:7rem 0 4rem;max-width:1100px">
    <a href="/blog/" style="text-decoration:none;font-size:.75rem;letter-spacing:1px;text-transform:uppercase;color:var(--primary)">← Блог</a>
    <h1 style="margin-top:1.5rem">{meta.title}</h1>
    <p class="blog-post__meta">
      <time datetime={meta.isoDate}>{meta.date}</time>
      <span aria-hidden="true"> · </span>
      <span class="blog-post__reading-time">{meta.readingTime} мин чтения</span>
    </p>
    {meta.categories.length ? (
      <div class="blog-post__tags">
        {meta.categories.map((cat) => (
          <span class="blog-post__tag">{cat}</span>
        ))}
      </div>
    ) : null}
    {coverSrc && (
      <figure class="blog-post__cover">
        <img src={coverSrc} alt={meta.title} loading="lazy" decoding="async" />
      </figure>
    )}
    {toc.length >= 6 && (
      <details class="blog-post__toc" aria-label="Оглавление статьи">
        <summary class="blog-post__toc-title">Содержание</summary>
        <ol class="blog-post__toc-list">
          {toc.filter(item => item.depth === 2).map((item) => (
            <li class="blog-post__toc-item">
              <a href={`#${item.slug}`} class="blog-post__toc-link">{item.text}</a>
            </li>
          ))}
        </ol>
      </details>
    )}
    <article class="blog-post">
      <Content />
    </article>
  </main>
  <Fragment slot="body-end">
    <script>
      import '@scripts/blog-post.ts';
    </script>
    <script is:inline>
      const bar = document.getElementById('readingBar');
      const rawPost = document.querySelector('.blog-post');
      if (bar && rawPost instanceof HTMLElement) {
        const post = rawPost;
        const update = () => {
          const offset = post.offsetTop - 70;
          const max = post.offsetHeight - window.innerHeight;
          const y = window.scrollY - offset;
          const ratio = max > 0 ? Math.min(1, Math.max(0, y / max)) : 0;
          bar.style.width = `${ratio * 100}%`;
        };
        window.addEventListener('scroll', update, { passive: true });
        window.addEventListener('load', update);
      }
    </script>
  </Fragment>
</MainLayout>
