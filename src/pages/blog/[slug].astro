---
import MainLayout from '../../layouts/MainLayout.astro';
import { getCollection } from 'astro:content';
import { buildSlug, collectMeta } from '../../lib/blog';
import siteConfig from '../../../site.config.json' with { type: 'json' };

export async function getStaticPaths() {
  const entries = await getCollection('blog', ({ data }) => !data.draft);
  return entries.map((entry) => ({
    params: { slug: buildSlug(entry) },
    props: { entry }
  }));
}

const { entry } = Astro.props;

if (!entry) {
  throw Astro.redirect('/blog/');
}

const { Content, headings } = await entry.render();
const meta = collectMeta(entry);
const toc = headings.filter((heading) => heading.depth === 2 || heading.depth === 3);
const canonical = `/blog/${meta.slug}/`;
const coverSrc = entry.data.cover ? `/${entry.data.cover.replace(/^\/+/, '')}` : undefined;
const description = meta.description || 'Статья школы японского языка';

const breadcrumbJson = {
  '@context': 'https://schema.org',
  '@type': 'BreadcrumbList',
  itemListElement: [
    { '@type': 'ListItem', position: 1, name: 'Главная', item: `${Astro.site?.href || siteConfig.siteUrl}/` },
    { '@type': 'ListItem', position: 2, name: 'Блог', item: `${Astro.site?.href || siteConfig.siteUrl}/blog/` },
    { '@type': 'ListItem', position: 3, name: meta.title, item: `${Astro.site?.href || siteConfig.siteUrl}/blog/${meta.slug}/` }
  ]
};

const articleJson = {
  '@context': 'https://schema.org',
  '@type': 'Article',
  headline: meta.title,
  datePublished: meta.isoDate,
  dateModified: meta.modified || meta.isoDate,
  description,
  image: coverSrc ? `${Astro.site?.href || siteConfig.siteUrl}${coverSrc}` : `${Astro.site?.href || siteConfig.siteUrl}/og-image.png`,
  mainEntityOfPage: `${Astro.site?.href || siteConfig.siteUrl}/blog/${meta.slug}/`,
  author: { '@type': 'Organization', name: siteConfig.siteName }
};
---
<MainLayout
  pageTitle={meta.title}
  description={description}
  keywords={meta.keywords}
  canonical={canonical}
  preloadImages={coverSrc ? [coverSrc] : []}
>
  <Fragment slot="head">
    <script is:inline type="application/ld+json" set:html={JSON.stringify(articleJson)} />
    <script is:inline type="application/ld+json" set:html={JSON.stringify(breadcrumbJson)} />
    <style is:global>
      .reading-progress{position:fixed;top:0;left:0;height:3px;width:100%;background:rgba(255, 255, 255, 0.08);z-index:300}
      .reading-progress span{display:block;height:100%;width:0;background:linear-gradient(90deg,var(--primary),var(--accent));transition:width .15s}
      .post-cover{margin:1.5rem 0 2rem}
      .post-cover img{max-width:100%;border-radius:var(--radius-lg);box-shadow:var(--shadow-lg);width:100%;height:auto}
      .post-meta-line{font-size:.65rem;letter-spacing:1.5px;text-transform:uppercase;margin:.9rem 0 1.25rem;color:var(--ink-dim)}
      .post-meta-line .rt{background:linear-gradient(90deg,var(--primary),var(--accent));-webkit-background-clip:text;background-clip:text;color:transparent;font-weight:600}
      .post-cats{display:flex;flex-wrap:wrap;gap:.4rem;margin:0 0 1.5rem}
      .cat-pill{background:rgba(var(--primary-rgb)/0.18);padding:.35rem .6rem .4rem;border-radius:18px;font-size:.55rem;letter-spacing:1px;text-transform:uppercase;color:var(--primary);border:1px solid rgba(var(--primary-rgb)/0.35)}
      .post-toc{position:relative;margin:1.75rem 0 2.25rem;padding:1rem 1.1rem;border:1px solid rgba(255, 255, 255, 0.08);border-radius:var(--radius);background:linear-gradient(135deg,var(--surface),var(--surface-alt));box-shadow:var(--shadow-sm);font-size:.85rem;max-width:420px}
      .post-toc .toc-title{font-size:.65rem;letter-spacing:1.5px;text-transform:uppercase;color:var(--ink-dim);margin-bottom:.55rem}
      .post-toc .toc-list{margin:0;padding:0;list-style:none;display:grid;gap:.35rem}
      .post-toc a{text-decoration:none;color:var(--ink-soft);position:relative;padding-left:.25rem;display:inline-block;line-height:1.3}
      .toc-li.lvl-3 a{padding-left:1rem;font-size:.78rem;opacity:.85}
      .toc-li.active>a{color:var(--primary);font-weight:600}
      .footnotes{margin-top:3rem;font-size:.85rem;border-top:1px solid rgba(255, 255, 255, 0.1);padding-top:1.5rem}
      .footnotes ol{margin:0;padding-left:1.2rem;display:grid;gap:.6rem}
      .footnotes a[href^="#fnref"]{text-decoration:none;font-size:.75rem;margin-left:.35rem;color:var(--primary)}
      .post-content :where(h2,h3){scroll-margin-top:90px}
    </style>
  </Fragment>
  <div class="reading-progress" aria-hidden="true"><span id="readingBar"></span></div>
  <main class="container rich-text" style="padding:7rem 0 4rem;max-width:820px">
    <a href="/blog/" style="text-decoration:none;font-size:.75rem;letter-spacing:1px;text-transform:uppercase;color:var(--primary)">← Блог</a>
    <h1 style="margin-top:1.5rem">{meta.title}</h1>
    <p class="post-meta-line">
      <time datetime={meta.isoDate}>{meta.date}</time>
      <span aria-hidden="true"> · </span>
      <span class="rt">{meta.readingTime} мин чтения</span>
    </p>
    {meta.categories.length ? (
      <div class="post-cats">
        {meta.categories.map((cat) => (
          <span class="cat-pill">{cat}</span>
        ))}
      </div>
    ) : null}
    {coverSrc && (
      <figure class="post-cover">
        <img src={coverSrc} alt={meta.title} loading="lazy" decoding="async" />
      </figure>
    )}
    {toc.length >= 3 && (
      <nav class="post-toc" aria-label="Оглавление статьи">
        <div class="toc-title">Содержание</div>
        <ol class="toc-list">
          {toc.map((item) => (
            <li class={`toc-li lvl-${item.depth}`}>
              <a href={`#${item.slug}`}>{item.text}</a>
            </li>
          ))}
        </ol>
      </nav>
    )}
    <article class="post-content">
      <Content />
    </article>
  </main>
  <Fragment slot="body-end">
    <script type="module" src="/src/scripts/blog-post.js"></script>
    <script is:inline>
      const bar = document.getElementById('readingBar');
      const rawPost = document.querySelector('.post-content');
      if (bar && rawPost instanceof HTMLElement) {
        const post = rawPost;
        const update = () => {
          const offset = post.offsetTop - 70;
          const max = post.offsetHeight - window.innerHeight;
          const y = window.scrollY - offset;
          const ratio = max > 0 ? Math.min(1, Math.max(0, y / max)) : 0;
          bar.style.width = `${ratio * 100}%`;
        };
        window.addEventListener('scroll', update, { passive: true });
        window.addEventListener('load', update);
      }
    </script>
  </Fragment>
</MainLayout>
