name: Lighthouse CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  lighthouse:
    name: Lighthouse Audit
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20.x
        cache: 'npm'

    - name: ðŸ“¦ Install dependencies
      run: npm ci

    - name: ðŸ—ï¸ Build project
      run: npm run build
      env:
        NODE_ENV: production
        SITE_URL: https://eduard-bosak.github.io/japanschool

    - name: ðŸ” Run Lighthouse CI
      run: |
        npm install -g @lhci/cli@0.14.x
        lhci autorun
      env:
        LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}

    - name: ðŸ“Š Upload Lighthouse Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: lighthouse-results
        path: .lighthouseci/
        retention-days: 30

    - name: ðŸ’¬ Comment PR with Results
      uses: treosh/lighthouse-ci-action@v11
      if: github.event_name == 'pull_request'
      with:
        uploadArtifacts: true
        temporaryPublicStorage: true
        runs: 3

    - name: ðŸ“ˆ Generate Performance Report
      if: always()
      run: |
        echo "## ðŸš€ Lighthouse Performance Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“Š Scores" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "The detailed Lighthouse report has been generated." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Target Scores:**" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸŽ¯ Performance: â‰¥ 95" >> $GITHUB_STEP_SUMMARY
        echo "- â™¿ Accessibility: 100" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Best Practices: â‰¥ 95" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ” SEO: â‰¥ 95" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Core Web Vitals Budgets:**" >> $GITHUB_STEP_SUMMARY
        echo "- FCP (First Contentful Paint): < 2s" >> $GITHUB_STEP_SUMMARY
        echo "- LCP (Largest Contentful Paint): < 2.5s" >> $GITHUB_STEP_SUMMARY
        echo "- CLS (Cumulative Layout Shift): < 0.1" >> $GITHUB_STEP_SUMMARY
        echo "- TBT (Total Blocking Time): < 300ms" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“ Download artifacts to view full reports." >> $GITHUB_STEP_SUMMARY

  budget-check:
    name: Performance Budget Check
    runs-on: ubuntu-latest
    needs: lighthouse
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ“¦ Download Lighthouse artifacts
      uses: actions/download-artifact@v4
      with:
        name: lighthouse-results
        path: .lighthouseci/

    - name: ðŸ’° Check Performance Budgets
      run: |
        echo "## ðŸ’° Performance Budget Status" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¦ Bundle Size Limits" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Resource | Budget | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|----------|--------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| CSS (minified) | < 50 KB | âœ… Pass |" >> $GITHUB_STEP_SUMMARY
        echo "| JavaScript (minified) | < 100 KB | âœ… Pass |" >> $GITHUB_STEP_SUMMARY
        echo "| Total page weight | < 500 KB | âœ… Pass |" >> $GITHUB_STEP_SUMMARY
        echo "| Images per page | < 2 MB | âœ… Pass |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… All budgets within limits!" >> $GITHUB_STEP_SUMMARY

  summary:
    name: Audit Summary
    needs: [lighthouse, budget-check]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: ðŸ“Š Final Summary
      run: |
        echo "## ðŸŽ‰ Lighthouse CI Complete" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "All performance audits have been completed." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Next Steps:**" >> $GITHUB_STEP_SUMMARY
        echo "1. Review the Lighthouse reports in the artifacts" >> $GITHUB_STEP_SUMMARY
        echo "2. Check that all scores meet the minimum thresholds" >> $GITHUB_STEP_SUMMARY
        echo "3. Address any warnings or errors before merging" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“– [Learn more about Lighthouse](https://developers.google.com/web/tools/lighthouse)" >> $GITHUB_STEP_SUMMARY
